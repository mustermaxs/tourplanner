@page "/tours/{TourId}"

@inject NavigationManager NavManager
@inject TourDetailsPageViewModel TourVM

<PageTitle>@TourVM.Tour.Name</PageTitle>

@if (TourVM.Tour == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="tour-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1>@TourVM.Tour.Name</h1>
        <div>
            <button class="btn btn-danger" @onclick="DeleteTour">
                Delete
            </button>
            <button class="btn btn-primary" @onclick="EditTour">
                Edit
            </button>
        </div>
    </div>
        <hr>
        @* Description *@
        <p>@TourVM.Tour.Description</p>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th></th>
                <th>Info</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                @* Estimated time *@
                <td><i class="icon-clock"></i></td>
                <td>Estimated time</td>
                <td>@FormatEstimatedTime(TourVM.Tour.EstimatedTime) h</td>
            </tr>
            <tr>
                @* From *@
                <td><i class="icon-location"></i></td>
                <td>From</td>
                <td>@TourVM.Tour.From</td>
            </tr>
            <tr>
                @* To *@
                <td><i class="icon-destination"></i></td>
                <td>To</td>
                <td>@TourVM.Tour.To</td>
            </tr>
            <tr>
                @* Transport Type *@
                <td><i class="icon-transport"></i></td>
                <td>Transport type</td>
                <td>@TourVM.Tour.TransportType</td>
            </tr>
            <tr>
                @* ChildFriendliness *@
                <td><i class="icon-child"></i></td>
                <td>Child Friendliness</td>
                <td>
                    <div class="progress" style="position: relative;">
                        <div class="progress-bar" role="progressbar" style="width: @(TourVM.Tour.ChildFriendliness * 10)%"
                            aria-valuenow="@TourVM.Tour.ChildFriendliness" aria-valuemin="0" aria-valuemax="10">
                        </div>
                        <div class="progress-text" style="color: @(TourVM.Tour.ChildFriendliness < 5 ? "black" : "white; text-shadow:0px 0px 3px black"); position: absolute; top: 0; left: 0; width: 100%; text-align: center;">@TourVM.Tour.ChildFriendliness / 10</div>
                        </div>
                </td>
            </tr>
            <tr>
                @* Popularity *@
                <td><i class="icon-heart"></i></td>
                <td>Popularity</td>
                <td>
                    <div class="progress" style="position: relative;">
                        <div class="progress-bar" role="progressbar" style="width: @(TourVM.Tour.Popularity * 10)%"
                            aria-valuenow="@TourVM.Tour.Popularity" aria-valuemin="0" aria-valuemax="10">
                        </div>
                        <div class="progress-text" style="color: @(TourVM.Tour.ChildFriendliness < 5 ? "black" : "white; text-shadow:0px 0px 3px black"); position: absolute; top: 0; left: 0; width: 100%; text-align: center;">@TourVM.Tour.Popularity / 10</div>
                    </div>
                </td>
            </tr>


        </tbody>
    </table>

    @* Image *@
    <div class="tour-map">
        <img src="map.png" alt="Map">
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <h2>Logs</h2>
        <button class="btn btn-primary" @onclick="AddLog">+ Add Log</button>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Comment</th>
                <th>Difficulty</th>
                <th>Duration (hrs)</th>
                <th>Rating</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var log in TourVM.TourLogs)
            {
                <tr>
                    <a href="/tours/@TourId/log/@log.Id">
                        <td>@log.DateTime.ToString("yyyy-MM-dd")</td>
                    </a>
                    <td>@log.Comment</td>
                    <td>@log.Difficulty</td>
                    <td>@log.Duration</td>
                    <td>@log.Rating</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Parameter] public string? TourId { get; set; }
    protected override async Task OnInitializedAsync()
    {
        int id = Convert.ToInt32(TourId);
        await TourVM.InitializeAsync(Convert.ToInt32(TourId));
            StateHasChanged();
    }
    private void EditTour()
    {
       NavManager.NavigateTo($"/edit/{TourId}");
    }
    private void AddLog()
    {
        NavManager.NavigateTo($"/tour/{TourId}/add-log");
    }

    private async void DeleteTour()
    {
        await TourVM.DeleteTour();
        NavManager.NavigateTo("/tours");
    }

    private string FormatEstimatedTime(double minutes) // TODO ins ViewModel geben
    {
        double hours = minutes / 60;
        if (hours % 1 == 0) {
            return $"{hours:0}";
        } else if ((hours * 10) % 10 == 5) {
            return $"{hours:0.0}";
        } else {
            return $"{hours:0.00}";
        }
    }
}